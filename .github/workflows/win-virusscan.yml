name: Windows-Virusscan
on: [push]
jobs:
  win-virusscan:
    name: Execute Virustotal Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.19

      - name: Build and Scan
        env:
          VTCLI_APIKEY: ${{secrets.VTCLI_APIKEY}}
        run: |
          # Build rport for windows
          VERSION=$(date -u +%y.%m%d.%H%M)
          BIN=./rport-$VERSION.exe
          GOOS=windows go build -v -ldflags="-X 'github.com/cloudradar-monitoring/rport/share.BuildVersion=$VERSION-$(git rev-parse HEAD)'"\
            -o $BIN ./cmd/rport/...
          echo "‚úÖ $BIN compiled"
          # Install the virus total cli
          curl -LO https://github.com/VirusTotal/vt-cli/releases/download/0.10.4/Linux64.zip
          unzip Linux64.zip
          echo "‚úÖ vt cli installed"
          ./vt version
          pip3 install yq
          ./vt scan file $BIN |tee vtscan
          echo "üöö $BIN queded for scanning"
          SCAN_ID=$(cat vtscan|awk '{print $2}')
          echo "‚è≥ Waiting for results..."
          for I in $(seq 1 60);do
            echo "${I}/60"
            STATUS=$(vt analysis YzA1ZDcxOGQ3YWM3NDUyMDQwNGQ0NDkzY2JlZWMwYWI6MTY3MjA1NjgwNA==|tee vtresult|yq -r .[0].status)
            if [ $STATUS == "completed" ]; then
              echo "‚úÖ virus total scan finished"
              break
            fi
            sleep 2
          done
        
          if [ $(yq .[0].stats.malicious < vtresult) -gt 0 ]; then
            echo "‚ò¢Ô∏è Virus found. See detail above."
            false
          fi
          echo "‚úÖ no virus found"