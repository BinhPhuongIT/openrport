name: Go
on: [push]
jobs:
  golangci:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: go mod vendor
        run: go mod vendor

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: v1.32
          args: -c .golangci.yml
  test:
    name: Test Server/Client Nix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Test
        run: go test -race -v ./...

  test-win:
    name: Test Client Windows
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v2
      - name: Test
        run: go test -race -v ./client/...
      - name: CheckPowershell
        run: |
          ls "C:\Program Files\PowerShell\7\pwsh.exe"
      - name: InstallTaco
        run: |
          iwr https://github.com/cloudradar-monitoring/tacoscript/releases/download/latest/tacoscript-latest-windows-amd64.zip `
          -OutFile tacoscript-latest-windows-amd64.zip
          $dest = "C:\Program Files\tacoscript"
          mkdir $dest
          mkdir "$($dest)\bin"
          Expand-Archive -Path $file -DestinationPath $dest -force
          mv "$($dest)\tacoscript.exe" "$($dest)\bin"
          
          $ENV:PATH="$ENV:PATH;$($dest)\bin"
          
          [Environment]::SetEnvironmentVariable(
          "Path",
          [Environment]::GetEnvironmentVariable(
          "Path", [EnvironmentVariableTarget]::Machine
          ) + ";$($dest)\bin",
          [EnvironmentVariableTarget]::Machine
          )
          & tacoscript --version
