# File upload 

## Preface
Rport allows users to copy files from their local machines to one or many clients. The most common use case is the distribution of software or configuration files.

As an alternative user can write a script to download needed files from the Internet, but usually we don't want the client machine downloading it directly because a virus scan must happen at a central place first.

A recommended solution would be that the Rport administrator downloads the needed file by himself, performs all needed scans and uploads it to the rport server.
The latter is distributing it among the clients through the secure SSH connection.

```
    Browser | Rportcli | curl (you)
        file_xyz
------------------------- HTTP(s)        
           ᐁ
       RPort server 
------------------------- SSH       
    ᐁ       ᐁ       ᐁ
   cl_1    cl_2    cl_n  
```

## Data flow
- Rport administrator uploads file to Rport server by using [UPLOAD API](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/cloudradar-monitoring/rport/master/api-doc.yml#/Upload). 
With the file he provides all required information: target file path on client, list of client IDs etc 
- Rport server copies the file to a temp folder `[server] {data_dir}/filepush/xxx`, where `[server] data_dir` is a configuration option and xxx is a random unique file name generated by the Rport server.
- Rport server sends to the provided clients a lightweight JSON request indicating temp location of the uploaded file on the server `[server] {data_dir}/filepush/xxx`, target path on the client, md5 checksum etc.
- Rport client(s) starts an SFTP session on top of the existing SSH connection and downloads to file to a temp location `[client] {data_dir}/filepush/xxx`, where `[client] {data_dir}` is the client configuration option and xxx is a unique file name generated by server.
- If SFTP session succeeds, client renames the downloaded file from the temp location path to the given target path
- Additionally, it applies `chmod/chown` operations (for Linux if needed)

## Upload API
You can use [UPLOAD API](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/cloudradar-monitoring/rport/master/api-doc.yml#/Upload) upload a file to a Rport server.

REST API is not well suited for uploading files, so you can use the [multipart form data format](https://en.wikipedia.org/wiki/MIME#Multipart_messages).

The file itself is marked with the required `upload` key.

Except for the file itself the Rport server needs following information sent as text parts of a multipart request:

### client 
_(string required)_

ID of a client who should receive the file. You can use multiple `client` parts if needed to tranfer file to multiple clients.

### dest 
_(string required)_

Absolute path on the client(s) where the file should be placed. The path should contain also the file name, which can be the same as the source file name or different.

### force
_(bool string, optional, default false)_

By default, Rport client will ignore the uploaded file, if another file exists at the target path. If you want to overwrite it by all means,
you can provide the `force` flag which can be interpreted as a true value (e.g. `1` or `true`)

### sync 
_(bool string, optional, default false)_

As mentioned before, Rport client will ignore the upload request, if another file already exists at the target path.
By enabling the sync flag (e.g. `1` or `true`) you can change this behaviour. The Rport client will do the following:
- if a destination file exists and has a different md5 checksum, it will be overwritten by the new file
- if a destination file exists and a file mode parameter is provided (see below) and it is different than the file mode of the existing file,
Rport client will apply a `chmod` operation to it to change the file mode (for Unix only)
- if a destination file exists and a file owner or group is provided (see below) and the existing file has a different owner or group,
Rport client will apply a `chown` operation to it to change owner and group attributes (for Unix only)
- if a destination file doesn't exist, the file will be copied to the destination as mentioned before

### mode 
_(string, optional, default empty, for Unix only)_

Indicates the desired file mode of the target file. If nothing is given, the default file mode will be 0764.
If provided, the Rport client will explicitly apply the `chmod` operation on the target file disregard if it was overwritten or not.
Please note, that the current rport OS user should have sufficient permissions to perform this operation.

### user/group
_(string, optional, default empty, for Unix only)_

Indicates the desired file owner and group of the target file. If nothing is given, the current Rport client user and his default group will be used.

If provided, the Rport client will explicitly apply the `chown` operation on the target file disregard if it was overwritten or not.
On Unix the Rport runs by default with a non-root user rights which disallows `chown` operations.

The user must create sudo rules for that. This allows a fine-grained control over which folders are accessible for the rport client.

Of course those limitations are not applicable if rport client runs as a sudo user.

Here is an example of a possible curl request will all parameters:

```
curl -XPOST \
-H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFwIiwic2NvcGVzIjpbeyJ1cmkiOiIqIiwibWV0aG9kIjoiKiJ9LHsidXJpIjoiL2FwaS92MS92ZXJpZnktMmZhIiwibWV0aG9kIjoiKiIsImV4Y2x1ZGUiOnRydWV9XSwianRpIjoiMTMxNDEzNTcxNTgxNjk5Njk3MDAifQ.az3I9cod3CAuUOi1UF7c9iECIH__RLELYTPO7_V04wk' \ 
-F 'upload=@/home/myuser/some-file.txt' \
-F 'client=89C4AB76-D90A-555C-85BF-9F8770A3036F' \
-F 'client=b4f795ef-718f-4f69-8f6f-b304b38a904f' \
-F 'dest=/Users/breathbath/Projects/rport/dist/data/client/Doriana Schauer3.vcf' \
-F 'force=true' \
-F 'sync=true' \
-F 'mode=0744' \
-F 'user=breathbath' \ 
-F 'group=staff' \ 
http://localhost:3000/api/v1/files
```

## Tracking upload results
Uploading of a large file to multiple clients might take a while, therefore server will transfer the data asynchronious without blocking your request.

This means that you get the response as soon as the file is completely sent to the server rather than waiting for file distribution to all clients.

This allows to avoid timeouts and large waiting times, on the other hand you won't see the upload results for individual clients in the response.

If you want to track upload process, you can use a websocket API (similar to commands websocket API where you can track execution of scripts/commands on individual clients as soon as they finish).

You can use [our testing API for Websockets](https://petstore.swagger.io/?url=https://raw.githubusercontent.com/cloudradar-monitoring/rport/master/api-doc.yml#/Upload/get_ws_uploads).
To use this API, enable testing endpoints by setting `enable_ws_test_endpoints` flag to true in the `[server]` section of configuration file:
```
[server]
...
  enable_ws_test_endpoints = true
```

Restart Rport server and go to: `{YOUR_RPORT_ADDRESS}/api/v1/test/uploads/ui`

Put an access token in the corresponding field.

Click Open to start websocket connection.

The websocket API will give you information about all uploads happening after you open a ws connection.

Here is an example payload you're usually getting through the ws upload API:

```
{
  "client_id": "89C4AB76-D90A-555C-85BF-9F8770A3036F",
  "uuid": "482ae29e-d372-4d21-8cb4-58d75482b7e1",
  "filepath": "/target/file.txt",
  "size": 17118,
  "message": "file successfully copied to destination",
  "status": "success"
}
```

This message indicates, that the upload of file `/target/file.txt` with size 17118 bytes was successful for the client `89C4AB76-D90A-555C-85BF-9F8770A3036F`.

Similarly, errors os warnings will be reported in the same format e.g.:

```
{
  "client_id": "89C4AB76-D90A-555C-85BF-9F8770A3036F",
  "uuid": "2ea7863b-94ae-4a91-87de-a85bc105ad4e",
  "filepath": "",
  "size": 0,
  "message": "rename /data/filepush/2ea7863b-94ae-4a91-87de-a85bc105ad4e_rport_filepush /etc/lala.txt: permission denied",
  "status": "error"
}
```

This message indicates that the Rport client tried to move temp file `/data/filepush/2ea7863b-94ae-4a91-87de-a85bc105ad4e_rport_filepush` 
to `/etc/lala.txt` but had no permissions to do it.

Websocket API will deliver upload results in the realtime but only after you open the connection. That means that if you want to track upload process,
you need first to open a websocket connection and then perform all uploads. 

You will get results about all clients and uploads happening in the current server. If you want to stop listening, just close the connection.

## Folder restrictions
By default, Rport client can place files anywhere in the file system where the rport OS user is allowed to write files.

That means, that running rport as sudo user (for Unix only), will give write access to the whole filesystem of the client.

You can additionally specify the list of folders/patterns where the rport client is not allowed to write files to.

You can define them as a list of [glob patterns](https://en.wikipedia.org/wiki/Glob_(programming)) in the `[file-push] file_push_deny` configuration section of an rport client.
Default list is `['/bin', '/sbin', '/boot', '/usr/bin', '/usr/sbin', '/dev', '/lib*', '/run']` for Unix and `['C:\Windows\', 'C:\ProgramData']` for Windows.

The restriction is applied to the target folder rather than target file
